<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>æ‰‘å…‹ç‰Œæ¸¸æˆ</title>
    <link rel="stylesheet" href="poke/css/common.css"/>
    <script src="poke/plugins/jQuery/jquery-1.8.3.min.js"></script>
    <script src="poke/plugins/placeholder/placeholder.js"></script>
    <script src="poke/plugins/layer/layer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="poke/js/common.js"></script>
</head>
<body>
    <div id="loginForm">
        <h2>ç™»å½•æ¸¸æˆ</h2>
        <input type="text" id="playerName" placeholder="è¯·è¾“å…¥ç©å®¶åç§°">
        <button onclick="login()">ç™»å½•</button>
    </div>

    <div id="gameRoom" style="display: none;">
        <table class="poke" width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
                <td colspan="3" height="5%" class="header">
                    <h1><img src="poke/images/icon.png"/>æ‰‘å…‹ç‰Œæ¸¸æˆ</h1>
                    <div class="game-status">
                        <span id="gameStatusText">ç­‰å¾…ä¸­</span>
                        <button id="readyButton" onclick="toggleReady()" class="ready-btn">å‡†å¤‡</button>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="mainView" height="65%" style="width:70%; background:url('poke/images/logobg.png') no-repeat 50% 50%">
                    <div class="topTips">
                        <h2>æœ¬æ¬¡æ‰“å‡ºçš„ç‰Œ</h2>
                        <div id="lastClaim" class="last-claim">ä¸Šä¸€å£°æ˜: <span></span></div>
                        <div class="current_pile" id="currentPile"></div>
                    </div>
                    <div class="current-player-indicator">
                        <p>å½“å‰ç©å®¶: <span id="currentPlayerName"></span></p>
                    </div>
                </td>
                <td width="15%" valign="top" align="center">
                    <h2 class="h2_title">å‡ºç‰Œå†å²</h2>
                    <div class="his_con">
                        <ol id="historyList"></ol>
                    </div>
                </td>
                <td valign="top" class="collapse_win" style="background:#0488c8">
                    <p class="joiner_num">å‚ä¸äººæ•°<span id="playerCount">0</span>äºº</p>
                    <div class="small_win">
                        <dl class="online">
                            <dt>åœ¨çº¿ç©å®¶</dt>
                            <dd id="playerList"></dd>
                        </dl>
                        <dl class="sort">
                            <dt>ç©å®¶æ’å</dt>
                            <dd id="playerRanking"></dd>
                        </dl>
                        <dl class="chat">
                            <dt>èŠå¤©çª—å£</dt>
                            <dd>
                                <div class="chat_con">
                                    <ol id="chatList"></ol>
                                </div>
                                <div class="input_area">
                                    <input type="text" id="chatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹" class="input_text"/>
                                    <div class="emoji-picker">
                                        <button onclick="toggleEmojiPicker()" class="emoji-btn">ğŸ˜Š</button>
                                        <div id="emojiContainer" class="emoji-container" style="display:none;">
                                            <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
                                            <span onclick="addEmoji('ğŸ‘')">ğŸ‘</span>
                                            <span onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
                                            <span onclick="addEmoji('ğŸ®')">ğŸ®</span>
                                            <span onclick="addEmoji('ğŸƒ')">ğŸƒ</span>
                                        </div>
                                    </div>
                                    <span class="input_btn" onclick="sendChat()">å‘é€</span>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2" height="30%" valign="top">
                    <div class="hand">
                        <p>æ‰‹ç‰Œæ•°<span id="handCount">0</span></p>
                    </div>
                    <div class="card-selection-controls">
                        <div class="declared-value">
                            <label for="declaredValue">å£°æ˜ç‰Œå€¼:</label>
                            <select id="declaredValue">
                                <option value="1">A</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">J</option>
                                <option value="12">Q</option>
                                <option value="13">K</option>
                            </select>
                        </div>
                        <button class="select-all-btn" onclick="selectAllSameValue()">é€‰æ‹©ç›¸åŒç‚¹æ•°</button>
                        <button class="clear-selection-btn" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
                    </div>
                    <div class="mypoke clear" id="playerHand"></div>
                </td>
                <td valign="top" style="background:#0488c8">
                    <ul class="play">
                        <li><span class="btn turn" onclick="playCards()">å‡ºç‰Œ</span></li>
                        <li><span class="btn pass" onclick="pass()">è¿‡ç‰Œ</span></li>
                        <li><span class="btn challenge" onclick="challenge()">è´¨ç–‘</span></li>
                    </ul>
                    <div class="game-info">
                        <p>æ¸¸æˆè§„åˆ™:</p>
                        <ul>
                            <li>ç©å®¶è½®æµå‡ºç‰Œ</li>
                            <li>å¯ä»¥è™šå¼ å£°åŠ¿</li>
                            <li>å¦‚æœæ€€ç–‘å¯¹æ–¹è™šå¼ å£°åŠ¿å¯ä»¥è´¨ç–‘</li>
                            <li>è´¨ç–‘æ­£ç¡®åˆ™å¯¹æ–¹ç½šç‰Œï¼Œé”™è¯¯åˆ™è‡ªå·±ç½šç‰Œ</li>
                        </ul>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- æ¸¸æˆç»“æœå¼¹çª— -->
    <div id="gameResultModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="gameResultTitle">æ¸¸æˆç»“æŸ</h2>
            <p id="gameResultMessage"></p>
            <div id="playerRankingFinal"></div>
            <button onclick="restartGame()" class="restart-btn">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <!-- éŸ³é¢‘èµ„æº -->
    <audio id="cardSound" src="poke/sounds/card.mp3" preload="auto"></audio>
    <audio id="winSound" src="poke/sounds/win.mp3" preload="auto"></audio>
    <audio id="loseSound" src="poke/sounds/lose.mp3" preload="auto"></audio>
    <audio id="challengeSound" src="poke/sounds/challenge.mp3" preload="auto"></audio>

    <script>
        // å…¨å±€å˜é‡åœ¨common.jsä¸­å·²å®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡å¤å£°æ˜
        // let stompClient = null;
        // let currentPlayer = null;
        // let currentRoom = null;
        // let selectedCards = [];
        // let isReady = false;
        // let soundEnabled = true;

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºç™»å½•è¡¨å•
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').style.display = 'block';
            
            // ç›‘å¬æŒ‰é”®äº‹ä»¶å¤„ç†å›è½¦é”®ç™»å½•
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // connectå‡½æ•°å·²åœ¨common.jsä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡å¤å®šä¹‰
        // function connect() {
        //     const socket = new SockJS('/ws');
        //     stompClient = Stomp.over(socket);
        //     stompClient.connect({}, function(frame) {
        //         console.log('Connected: ' + frame);
        //         
        //         // è®¢é˜…æ¸¸æˆçŠ¶æ€æ›´æ–°
        //         stompClient.subscribe('/topic/game/state', function(gameState) {
        //             updateGameState(JSON.parse(gameState.body));
        //         });
        //         
        //         // è®¢é˜…èŠå¤©æ¶ˆæ¯
        //         stompClient.subscribe('/topic/game/chat', function(chatMessage) {
        //             addChatMessage(JSON.parse(chatMessage.body));
        //         });
        //         
        //         // è®¢é˜…æ¸¸æˆç»“æœ
        //         stompClient.subscribe('/topic/game/result', function(gameResult) {
        //             showGameResult(JSON.parse(gameResult.body));
        //         });
        //     }, function(error) {
        //         console.error('è¿æ¥é”™è¯¯:', error);
        //         // å°è¯•é‡æ–°è¿æ¥
        //         setTimeout(connect, 5000);
        //     });
        // }

        function login() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('è¯·è¾“å…¥ç©å®¶åç§°');
                return;
            }
            currentPlayer = playerName;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('gameRoom').style.display = 'block';
            connect();
            joinExistingRoomOrCreate();
        }

        function joinExistingRoomOrCreate() {
            // å…ˆå°è¯•è·å–ç°æœ‰æˆ¿é—´åˆ—è¡¨
            fetch('/api/game/rooms')
                .then(response => response.json())
                .then(rooms => {
                    if (rooms && rooms.length > 0) {
                        // æœ‰æˆ¿é—´åˆ™åŠ å…¥ç¬¬ä¸€ä¸ª
                        joinRoom(rooms[0].id);
                    } else {
                        // æ²¡æœ‰æˆ¿é—´åˆ™åˆ›å»ºæ–°æˆ¿é—´
                        createRoom();
                    }
                })
                .catch(error => {
                    console.error('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                    createRoom(); // å‡ºé”™ä¹Ÿåˆ›å»ºæ–°æˆ¿é—´
                });
        }

        function createRoom() {
            fetch('/api/game/room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    hostId: currentPlayer,
                    maxPlayers: 4
                })
            })
            .then(response => response.json())
            .then(room => {
                currentRoom = room;
                updateRoomInfo(room);
                joinRoom(room.id);
            })
            .catch(error => {
                console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error);
                alert('åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        function joinRoom(roomId) {
            fetch(`/api/game/room/${roomId}/join`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    playerId: currentPlayer
                })
            })
            .then(response => response.json())
            .then(room => {
                currentRoom = room;
                updateRoomInfo(room);
                playSound('cardSound');
            })
            .catch(error => {
                console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                alert('åŠ å…¥æˆ¿é—´å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        function toggleReady() {
            const readyButton = document.getElementById('readyButton');
            
            if (isReady) {
                // å·²ç»å‡†å¤‡äº†ï¼Œå–æ¶ˆå‡†å¤‡
                fetch(`/api/game/room/${currentRoom.id}/cancel-ready`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer
                    })
                })
                .then(response => {
                    if (response.ok) {
                        isReady = false;
                        readyButton.classList.remove('ready-active');
                        readyButton.textContent = 'å‡†å¤‡';
                    }
                });
            } else {
                // å‡†å¤‡
                fetch(`/api/game/room/${currentRoom.id}/ready`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer
                    })
                })
                .then(response => {
                    if (response.ok) {
                        isReady = true;
                        readyButton.classList.add('ready-active');
                        readyButton.textContent = 'å–æ¶ˆå‡†å¤‡';
                        playSound('cardSound');
                    }
                });
            }
        }

        function updateGameState(state) {
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ–‡æœ¬
            document.getElementById('gameStatusText').textContent = state.gameStatus || 'ç­‰å¾…ä¸­';
            
            // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
            document.getElementById('currentPlayerName').textContent = state.currentPlayer || '-';
            
            // é«˜äº®æ˜¾ç¤ºå½“å‰ç©å®¶
            updatePlayersList(state.players, state.readyPlayers, state.currentPlayer);
            
            // æ›´æ–°ç©å®¶æ•°é‡
            document.getElementById('playerCount').textContent = state.players ? state.players.length : 0;
            
            // æ›´æ–°æ‰‹ç‰Œ
            if (state.playerHands && state.playerHands[currentPlayer]) {
                updatePlayerHand(state.playerHands[currentPlayer]);
            }
            
            // æ›´æ–°å½“å‰ç‰Œå †
            updateCurrentPile(state.currentPile || []);
            
            // æ›´æ–°æœ€åå£°æ˜
            if (state.lastClaim) {
                document.querySelector('#lastClaim span').textContent = state.lastClaim;
                document.getElementById('lastClaim').style.display = 'block';
            } else {
                document.getElementById('lastClaim').style.display = 'none';
            }
            
            // ç¦ç”¨/å¯ç”¨æ¸¸æˆæ“ä½œæŒ‰é’®
            const isCurrentPlayer = state.currentPlayer === currentPlayer;
            const gameStarted = state.gameStatus === 'PLAYING';
            
            document.querySelector('.btn.turn').disabled = !isCurrentPlayer || !gameStarted;
            document.querySelector('.btn.pass').disabled = !isCurrentPlayer || !gameStarted;
            document.querySelector('.btn.challenge').disabled = !isCurrentPlayer || !gameStarted || !state.lastClaim;
            
            // å¦‚æœæ˜¯å½“å‰ç©å®¶çš„å›åˆï¼Œæ’­æ”¾æç¤ºéŸ³æ•ˆ
            if (isCurrentPlayer && gameStarted) {
                playSound('cardSound');
            }
        }

        function updateRoomInfo(room) {
            document.getElementById('gameStatusText').textContent = room.status || 'ç­‰å¾…ä¸­';
            document.getElementById('playerCount').textContent = room.players ? room.players.length : 0;
        }

        function updatePlayersList(players, readyPlayers, currentPlayer) {
            const playerListElement = document.getElementById('playerList');
            playerListElement.innerHTML = '';
            
            if (players && players.length > 0) {
                players.forEach(player => {
                    const isReady = readyPlayers && readyPlayers.includes(player);
                    const isCurrent = player === currentPlayer;
                    
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    if (isCurrent) playerElement.classList.add('current-player');
                    if (player === currentPlayer) playerElement.classList.add('self');
                    
                    playerElement.innerHTML = `
                        ${player} 
                        ${isReady ? '<span class="ready-status">å·²å‡†å¤‡</span>' : ''}
                        ${isCurrent ? '<span class="current-marker">â—</span>' : ''}
                    `;
                    
                    playerListElement.appendChild(playerElement);
                });
            }
        }

        function updatePlayerHand(cards) {
            const handContainer = document.getElementById('playerHand');
            handContainer.innerHTML = '';
            
            if (cards && cards.length > 0) {
                cards.sort((a, b) => a.value - b.value);
                
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.setAttribute('data-card', JSON.stringify(card));
                    cardElement.onclick = function() { selectCard(this); };
                    
                    // è®¾ç½®å¡ç‰Œå·¦è¾¹è·ï¼Œå®ç°æ‰‡å½¢æ’åˆ—æ•ˆæœ
                    cardElement.style.marginLeft = `${index * 30}px`;
                    
                    // è®¾ç½®å¡ç‰Œé¢œè‰²
                    const isRed = card.suit === 'HEARTS' || card.suit === 'DIAMONDS';
                    const cardColor = isRed ? 'red' : 'black';
                    
                    // è®¾ç½®å¡ç‰ŒèŠ±è‰²ç¬¦å·
                    let suitSymbol = 'â™ ';
                    switch (card.suit) {
                        case 'HEARTS': suitSymbol = 'â™¥'; break;
                        case 'DIAMONDS': suitSymbol = 'â™¦'; break;
                        case 'CLUBS': suitSymbol = 'â™£'; break;
                        case 'JOKER': suitSymbol = 'ğŸƒ'; break;
                    }
                    
                    // è®¾ç½®å¡ç‰Œç‚¹æ•°æ˜¾ç¤º
                    let valueDisplay = card.value;
                    switch (card.value) {
                        case 1: valueDisplay = 'A'; break;
                        case 11: valueDisplay = 'J'; break;
                        case 12: valueDisplay = 'Q'; break;
                        case 13: valueDisplay = 'K'; break;
                    }
                    
                    cardElement.innerHTML = `
                        <span class="lt pv" style="color:${cardColor}">${valueDisplay}</span>
                        <span class="cm" style="color:${cardColor}">${suitSymbol}</span>
                        <span class="rb pv" style="color:${cardColor}">${valueDisplay}</span>
                    `;
                    
                    handContainer.appendChild(cardElement);
                });
            }
            
            document.getElementById('handCount').textContent = cards ? cards.length : 0;
        }

        function selectCard(element) {
            element.classList.toggle('selected');
            const card = JSON.parse(element.getAttribute('data-card'));
            
            // æ£€æŸ¥å¡ç‰‡æ˜¯å¦å·²ç»è¢«é€‰ä¸­
            const cardIndex = selectedCards.findIndex(c => 
                c.suit === card.suit && c.value === card.value
            );
            
            if (cardIndex === -1) {
                // å¦‚æœæ²¡æœ‰è¢«é€‰ä¸­ï¼Œæ·»åŠ åˆ°é€‰æ‹©åˆ—è¡¨
                selectedCards.push(card);
                playSound('cardSound');
            } else {
                // å¦‚æœå·²ç»è¢«é€‰ä¸­ï¼Œä»é€‰æ‹©åˆ—è¡¨ç§»é™¤
                selectedCards.splice(cardIndex, 1);
            }
            
            // æ›´æ–°å£°æ˜å€¼ä¸‹æ‹‰æ¡†
            if (selectedCards.length > 0) {
                document.getElementById('declaredValue').value = selectedCards[0].value;
            }
        }

        function selectAllSameValue() {
            // å…ˆè·å–å½“å‰é€‰æ‹©çš„ç¬¬ä¸€å¼ ç‰Œçš„å€¼
            if (selectedCards.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ ç‰Œ');
                return;
            }
            
            const selectedValue = selectedCards[0].value;
            
            // æŸ¥æ‰¾æ‰€æœ‰å…·æœ‰ç›¸åŒå€¼çš„å¡ç‰‡å¹¶é€‰ä¸­å®ƒä»¬
            const cards = document.querySelectorAll('.card');
            cards.forEach(cardElement => {
                const card = JSON.parse(cardElement.getAttribute('data-card'));
                if (card.value === selectedValue) {
                    if (!cardElement.classList.contains('selected')) {
                        cardElement.classList.add('selected');
                        selectedCards.push(card);
                    }
                }
            });
            
            playSound('cardSound');
        }

        function clearSelection() {
            const cards = document.querySelectorAll('.card.selected');
            cards.forEach(card => {
                card.classList.remove('selected');
            });
            selectedCards = [];
        }

        function updateCurrentPile(cards) {
            const pileContainer = document.getElementById('currentPile');
            pileContainer.innerHTML = '';
            
            if (cards && cards.length > 0) {
                // åˆ›å»ºç‰Œå †å…ƒç´ 
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card pile-card';
                    
                    // è®¾ç½®å¡ç‰Œä½ç½®ï¼Œä½¿å…¶ç•¥å¾®é‡å 
                    cardElement.style.top = `${index * 5}px`;
                    cardElement.style.left = `${index * 10}px`;
                    cardElement.style.zIndex = index + 1;
                    
                    // è®¾ç½®å¡ç‰Œé¢œè‰²
                    const isRed = card.suit === 'HEARTS' || card.suit === 'DIAMONDS';
                    const cardColor = isRed ? 'red' : 'black';
                    
                    // è®¾ç½®å¡ç‰ŒèŠ±è‰²ç¬¦å·
                    let suitSymbol = 'â™ ';
                    switch (card.suit) {
                        case 'HEARTS': suitSymbol = 'â™¥'; break;
                        case 'DIAMONDS': suitSymbol = 'â™¦'; break;
                        case 'CLUBS': suitSymbol = 'â™£'; break;
                        case 'JOKER': suitSymbol = 'ğŸƒ'; break;
                    }
                    
                    // è®¾ç½®å¡ç‰Œç‚¹æ•°æ˜¾ç¤º
                    let valueDisplay = card.value;
                    switch (card.value) {
                        case 1: valueDisplay = 'A'; break;
                        case 11: valueDisplay = 'J'; break;
                        case 12: valueDisplay = 'Q'; break;
                        case 13: valueDisplay = 'K'; break;
                    }
                    
                    cardElement.innerHTML = `
                        <span class="lt pv" style="color:${cardColor}">${valueDisplay}</span>
                        <span class="cm" style="color:${cardColor}">${suitSymbol}</span>
                        <span class="rb pv" style="color:${cardColor}">${valueDisplay}</span>
                    `;
                    
                    pileContainer.appendChild(cardElement);
                });
            }
        }

        function addHistoryItem(message) {
            const historyList = document.getElementById('historyList');
            const historyItem = document.createElement('li');
            historyItem.textContent = message;
            historyList.appendChild(historyItem);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            historyList.scrollTop = historyList.scrollHeight;
        }

        function addChatMessage(chatMessage) {
            const chatList = document.getElementById('chatList');
            const chatItem = document.createElement('li');
            chatItem.innerHTML = `<strong>${chatMessage.sender}:</strong> ${chatMessage.content}`;
            
            // å¦‚æœæ˜¯å½“å‰ç©å®¶çš„æ¶ˆæ¯ï¼Œæ·»åŠ æ ·å¼
            if (chatMessage.sender === currentPlayer) {
                chatItem.classList.add('self-message');
            }
            
            chatList.appendChild(chatItem);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatList.scrollTop = chatList.scrollHeight;
        }

        function playCards() {
            if (selectedCards.length === 0) {
                alert('è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œ');
                return;
            }
            
            const declaredValue = document.getElementById('declaredValue').value;
            
            const message = {
                type: 'PLAY',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                cards: selectedCards,
                declaredCount: selectedCards.length,
                declaredValue: declaredValue
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addHistoryItem(`${currentPlayer} æ‰“å‡ºäº† ${selectedCards.length} å¼  ${declaredValue}`);
            
            // æ¸…é™¤é€‰æ‹©
            clearSelection();
            
            // æ’­æ”¾éŸ³æ•ˆ
            playSound('cardSound');
        }

        function pass() {
            const message = {
                type: 'PASS',
                roomId: currentRoom.id,
                playerId: currentPlayer
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addHistoryItem(`${currentPlayer} é€‰æ‹©äº†è¿‡ç‰Œ`);
            
            // æ’­æ”¾éŸ³æ•ˆ
            playSound('cardSound');
        }

        function challenge() {
            if (!currentRoom.lastPlayer) {
                alert('æ²¡æœ‰å¯ä»¥è´¨ç–‘çš„ç©å®¶');
                return;
            }
            
            const message = {
                type: 'CHALLENGE',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                targetPlayerId: currentRoom.lastPlayer
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addHistoryItem(`${currentPlayer} è´¨ç–‘äº† ${currentRoom.lastPlayer}`);
            
            // æ’­æ”¾éŸ³æ•ˆ
            playSound('challengeSound');
        }

        function sendChat() {
            const content = document.getElementById('chatInput').value.trim();
            if (!content) return;
            
            const message = {
                type: 'CHAT',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                content: content
            };
            
            stompClient.send("/app/game/chat", {}, JSON.stringify(message));
            document.getElementById('chatInput').value = '';
        }

        function toggleEmojiPicker() {
            const emojiContainer = document.getElementById('emojiContainer');
            emojiContainer.style.display = emojiContainer.style.display === 'none' ? 'block' : 'none';
        }

        function addEmoji(emoji) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value += emoji;
            document.getElementById('emojiContainer').style.display = 'none';
            chatInput.focus();
        }

        function showGameResult(result) {
            const modal = document.getElementById('gameResultModal');
            const titleElement = document.getElementById('gameResultTitle');
            const messageElement = document.getElementById('gameResultMessage');
            const rankingElement = document.getElementById('playerRankingFinal');
            
            // è®¾ç½®æ ‡é¢˜å’Œæ¶ˆæ¯
            titleElement.textContent = 'æ¸¸æˆç»“æŸ';
            messageElement.textContent = result.message || 'æ¸¸æˆç»“æŸ';
            
            // æ˜¾ç¤ºç©å®¶æ’å
            rankingElement.innerHTML = '';
            if (result.ranking && result.ranking.length > 0) {
                const rankingList = document.createElement('ol');
                result.ranking.forEach(player => {
                    const item = document.createElement('li');
                    item.textContent = `${player.name} - ${player.cards}å¼ ç‰Œ`;
                    rankingList.appendChild(item);
                });
                rankingElement.appendChild(rankingList);
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'block';
            
            // æ’­æ”¾éŸ³æ•ˆ
            if (result.winner === currentPlayer) {
                playSound('winSound');
            } else {
                playSound('loseSound');
            }
        }

        function restartGame() {
            // éšè—ç»“æœå¼¹çª—
            document.getElementById('gameResultModal').style.display = 'none';
            
            // é‡æ–°å¼€å§‹æ¸¸æˆ
            fetch(`/api/game/room/${currentRoom.id}/restart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    playerId: currentPlayer
                })
            });
            
            // é‡ç½®å‡†å¤‡çŠ¶æ€
            isReady = false;
            document.getElementById('readyButton').classList.remove('ready-active');
            document.getElementById('readyButton').textContent = 'å‡†å¤‡';
            
            // æ¸…é™¤å†å²è®°å½•
            document.getElementById('historyList').innerHTML = '';
            
            // æ¸…é™¤é€‰æ‹©
            clearSelection();
        }

        function playSound(soundId) {
            if (soundEnabled) {
                try {
                    const sound = document.getElementById(soundId);
                    sound.currentTime = 0;
                    sound.play();
                } catch (e) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
                }
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundButton = document.getElementById('soundToggle');
            soundButton.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        // å¤„ç†æ¸¸æˆé€šçŸ¥
        function handleNotification(notification) {
            var chatArea = $("#chatArea");
            var message = notification.content;
            
            // ä¸åŒç±»å‹çš„é€šçŸ¥æ˜¾ç¤ºä¸åŒçš„æ ·å¼
            var messageClass = "";
            if (notification.type === "JOIN") {
                messageClass = "join-notification";
            } else if (notification.type === "LEAVE") {
                messageClass = "leave-notification";
            } else if (notification.type === "PLAY") {
                messageClass = "play-notification";
            } else if (notification.type === "PASS") {
                messageClass = "pass-notification";
            } else if (notification.type === "CHALLENGE") {
                messageClass = "challenge-notification";
            } else if (notification.type === "GAME_START") {
                messageClass = "start-notification";
            } else if (notification.type === "GAME_END") {
                messageClass = "end-notification";
                // æ¸¸æˆç»“æŸæ—¶æ˜¾ç¤ºæ’åå¼¹çª—
                showGameEndDialog(notification.content);
            } else if (notification.type === "ERROR") {
                messageClass = "error-notification";
            }
            
            chatArea.append("<p class='" + messageClass + "'>" + message + "</p>");
            chatArea.scrollTop(chatArea[0].scrollHeight);
        }
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        function showGameEndDialog(rankingText) {
            // åˆ›å»ºå¼¹çª—
            var dialog = $("<div class='game-end-dialog'></div>");
            var content = $("<div class='game-end-content'></div>");
            
            // è®¾ç½®æ ‡é¢˜
            content.append("<h2>æ¸¸æˆç»“æŸ</h2>");
            
            // æ·»åŠ æ’åä¿¡æ¯
            var rankingLines = rankingText.split("\n");
            var rankingHtml = "<div class='ranking'>";
            
            // è·³è¿‡ç¬¬ä¸€è¡Œ"æ¸¸æˆç»“æŸï¼æ’åï¼š"ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹
            for (var i = 1; i < rankingLines.length; i++) {
                rankingHtml += "<p>" + rankingLines[i] + "</p>";
            }
            rankingHtml += "</div>";
            content.append(rankingHtml);
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            var closeButton = $("<button class='close-btn'>å…³é—­</button>");
            closeButton.click(function() {
                dialog.remove();
            });
            content.append(closeButton);
            
            // æ·»åŠ åˆ°å¼¹çª—
            dialog.append(content);
            
            // æ·»åŠ åˆ°é¡µé¢
            $("body").append(dialog);
        }
    </script>
</body>
</html>