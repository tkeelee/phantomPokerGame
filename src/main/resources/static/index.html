<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>扑克牌游戏</title>
    <link rel="stylesheet" href="poke/css/common.css"/>
    <script src="poke/plugins/jQuery/jquery-1.8.3.min.js"></script>
    <script src="poke/plugins/placeholder/placeholder.js"></script>
    <script src="poke/plugins/layer/layer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="poke/js/common.js"></script>
</head>
<body>
    <div id="loginForm">
        <h2>登录游戏</h2>
        <input type="text" id="playerName" placeholder="请输入玩家名称">
        <button onclick="login()">登录</button>
    </div>

    <div id="gameRoom" style="display: none;">
        <table class="poke" width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
                <td colspan="3" height="5%" class="header">
                    <h1><img src="poke/images/icon.png"/>扑克牌游戏</h1>
                    <div class="game-status">
                        <span id="gameStatusText">等待中</span>
                        <button id="readyButton" onclick="toggleReady()" class="ready-btn">准备</button>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="mainView" height="65%" style="width:70%; background:url('poke/images/logobg.png') no-repeat 50% 50%">
                    <div class="topTips">
                        <h2>本次打出的牌</h2>
                        <div id="lastClaim" class="last-claim">上一声明: <span></span></div>
                        <div class="current_pile" id="currentPile"></div>
                    </div>
                    <div class="current-player-indicator">
                        <p>当前玩家: <span id="currentPlayerName"></span></p>
                    </div>
                </td>
                <td width="15%" valign="top" align="center">
                    <h2 class="h2_title">出牌历史</h2>
                    <div class="his_con">
                        <ol id="historyList"></ol>
                    </div>
                </td>
                <td valign="top" class="collapse_win" style="background:#0488c8">
                    <p class="joiner_num">参与人数<span id="playerCount">0</span>人</p>
                    <div class="small_win">
                        <dl class="online">
                            <dt>在线玩家</dt>
                            <dd id="playerList"></dd>
                        </dl>
                        <dl class="sort">
                            <dt>玩家排名</dt>
                            <dd id="playerRanking"></dd>
                        </dl>
                        <dl class="chat">
                            <dt>聊天窗口</dt>
                            <dd>
                                <div class="chat_con">
                                    <ol id="chatList"></ol>
                                </div>
                                <div class="input_area">
                                    <input type="text" id="chatInput" placeholder="输入聊天内容" class="input_text"/>
                                    <div class="emoji-picker">
                                        <button onclick="toggleEmojiPicker()" class="emoji-btn">😊</button>
                                        <div id="emojiContainer" class="emoji-container" style="display:none;">
                                            <span onclick="addEmoji('😊')">😊</span>
                                            <span onclick="addEmoji('👍')">👍</span>
                                            <span onclick="addEmoji('😂')">😂</span>
                                            <span onclick="addEmoji('🎮')">🎮</span>
                                            <span onclick="addEmoji('🃏')">🃏</span>
                                        </div>
                                    </div>
                                    <span class="input_btn" onclick="sendChat()">发送</span>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2" height="30%" valign="top">
                    <div class="hand">
                        <p>手牌数<span id="handCount">0</span></p>
                    </div>
                    <div class="card-selection-controls">
                        <div class="declared-value">
                            <label for="declaredValue">声明牌值:</label>
                            <select id="declaredValue">
                                <option value="1">A</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">J</option>
                                <option value="12">Q</option>
                                <option value="13">K</option>
                            </select>
                        </div>
                        <button class="select-all-btn" onclick="selectAllSameValue()">选择相同点数</button>
                        <button class="clear-selection-btn" onclick="clearSelection()">清除选择</button>
                    </div>
                    <div class="mypoke clear" id="playerHand"></div>
                </td>
                <td valign="top" style="background:#0488c8">
                    <ul class="play">
                        <li><span class="btn turn" onclick="playCards()">出牌</span></li>
                        <li><span class="btn pass" onclick="pass()">过牌</span></li>
                        <li><span class="btn challenge" onclick="challenge()">质疑</span></li>
                    </ul>
                    <div class="game-info">
                        <p>游戏规则:</p>
                        <ul>
                            <li>玩家轮流出牌</li>
                            <li>可以虚张声势</li>
                            <li>如果怀疑对方虚张声势可以质疑</li>
                            <li>质疑正确则对方罚牌，错误则自己罚牌</li>
                        </ul>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- 游戏结果弹窗 -->
    <div id="gameResultModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="gameResultTitle">游戏结束</h2>
            <p id="gameResultMessage"></p>
            <div id="playerRankingFinal"></div>
            <button onclick="restartGame()" class="restart-btn">再来一局</button>
        </div>
    </div>

    <!-- 音频资源 -->
    <audio id="cardSound" src="poke/sounds/card.mp3" preload="auto"></audio>
    <audio id="winSound" src="poke/sounds/win.mp3" preload="auto"></audio>
    <audio id="loseSound" src="poke/sounds/lose.mp3" preload="auto"></audio>
    <audio id="challengeSound" src="poke/sounds/challenge.mp3" preload="auto"></audio>

    <script>
        // 全局变量在common.js中已定义，这里不再重复声明
        // let stompClient = null;
        // let currentPlayer = null;
        // let currentRoom = null;
        // let selectedCards = [];
        // let isReady = false;
        // let soundEnabled = true;

        // 页面加载完成后显示登录表单
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').style.display = 'block';
            
            // 监听按键事件处理回车键登录
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // connect函数已在common.js中定义，这里不再重复定义
        // function connect() {
        //     const socket = new SockJS('/ws');
        //     stompClient = Stomp.over(socket);
        //     stompClient.connect({}, function(frame) {
        //         console.log('Connected: ' + frame);
        //         
        //         // 订阅游戏状态更新
        //         stompClient.subscribe('/topic/game/state', function(gameState) {
        //             updateGameState(JSON.parse(gameState.body));
        //         });
        //         
        //         // 订阅聊天消息
        //         stompClient.subscribe('/topic/game/chat', function(chatMessage) {
        //             addChatMessage(JSON.parse(chatMessage.body));
        //         });
        //         
        //         // 订阅游戏结果
        //         stompClient.subscribe('/topic/game/result', function(gameResult) {
        //             showGameResult(JSON.parse(gameResult.body));
        //         });
        //     }, function(error) {
        //         console.error('连接错误:', error);
        //         // 尝试重新连接
        //         setTimeout(connect, 5000);
        //     });
        // }

        function login() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('请输入玩家名称');
                return;
            }
            currentPlayer = playerName;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('gameRoom').style.display = 'block';
            connect();
            joinExistingRoomOrCreate();
        }

        function joinExistingRoomOrCreate() {
            // 先尝试获取现有房间列表
            fetch('/api/game/rooms')
                .then(response => response.json())
                .then(rooms => {
                    if (rooms && rooms.length > 0) {
                        // 有房间则加入第一个
                        joinRoom(rooms[0].id);
                    } else {
                        // 没有房间则创建新房间
                        createRoom();
                    }
                })
                .catch(error => {
                    console.error('获取房间列表失败:', error);
                    createRoom(); // 出错也创建新房间
                });
        }

        function createRoom() {
            fetch('/api/game/room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    hostId: currentPlayer,
                    maxPlayers: 4
                })
            })
            .then(response => response.json())
            .then(room => {
                currentRoom = room;
                updateRoomInfo(room);
                joinRoom(room.id);
            })
            .catch(error => {
                console.error('创建房间失败:', error);
                alert('创建房间失败，请重试');
            });
        }

        function joinRoom(roomId) {
            fetch(`/api/game/room/${roomId}/join`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    playerId: currentPlayer
                })
            })
            .then(response => response.json())
            .then(room => {
                currentRoom = room;
                updateRoomInfo(room);
                playSound('cardSound');
            })
            .catch(error => {
                console.error('加入房间失败:', error);
                alert('加入房间失败，请重试');
            });
        }

        function toggleReady() {
            const readyButton = document.getElementById('readyButton');
            
            if (isReady) {
                // 已经准备了，取消准备
                fetch(`/api/game/room/${currentRoom.id}/cancel-ready`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer
                    })
                })
                .then(response => {
                    if (response.ok) {
                        isReady = false;
                        readyButton.classList.remove('ready-active');
                        readyButton.textContent = '准备';
                    }
                });
            } else {
                // 准备
                fetch(`/api/game/room/${currentRoom.id}/ready`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: currentPlayer
                    })
                })
                .then(response => {
                    if (response.ok) {
                        isReady = true;
                        readyButton.classList.add('ready-active');
                        readyButton.textContent = '取消准备';
                        playSound('cardSound');
                    }
                });
            }
        }

        function updateGameState(state) {
            // 更新游戏状态文本
            document.getElementById('gameStatusText').textContent = state.gameStatus || '等待中';
            
            // 更新当前玩家指示
            document.getElementById('currentPlayerName').textContent = state.currentPlayer || '-';
            
            // 高亮显示当前玩家
            updatePlayersList(state.players, state.readyPlayers, state.currentPlayer);
            
            // 更新玩家数量
            document.getElementById('playerCount').textContent = state.players ? state.players.length : 0;
            
            // 更新手牌
            if (state.playerHands && state.playerHands[currentPlayer]) {
                updatePlayerHand(state.playerHands[currentPlayer]);
            }
            
            // 更新当前牌堆
            updateCurrentPile(state.currentPile || []);
            
            // 更新最后声明
            if (state.lastClaim) {
                document.querySelector('#lastClaim span').textContent = state.lastClaim;
                document.getElementById('lastClaim').style.display = 'block';
            } else {
                document.getElementById('lastClaim').style.display = 'none';
            }
            
            // 禁用/启用游戏操作按钮
            const isCurrentPlayer = state.currentPlayer === currentPlayer;
            const gameStarted = state.gameStatus === 'PLAYING';
            
            document.querySelector('.btn.turn').disabled = !isCurrentPlayer || !gameStarted;
            document.querySelector('.btn.pass').disabled = !isCurrentPlayer || !gameStarted;
            document.querySelector('.btn.challenge').disabled = !isCurrentPlayer || !gameStarted || !state.lastClaim;
            
            // 如果是当前玩家的回合，播放提示音效
            if (isCurrentPlayer && gameStarted) {
                playSound('cardSound');
            }
        }

        function updateRoomInfo(room) {
            document.getElementById('gameStatusText').textContent = room.status || '等待中';
            document.getElementById('playerCount').textContent = room.players ? room.players.length : 0;
        }

        function updatePlayersList(players, readyPlayers, currentPlayer) {
            const playerListElement = document.getElementById('playerList');
            playerListElement.innerHTML = '';
            
            if (players && players.length > 0) {
                players.forEach(player => {
                    const isReady = readyPlayers && readyPlayers.includes(player);
                    const isCurrent = player === currentPlayer;
                    
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    if (isCurrent) playerElement.classList.add('current-player');
                    if (player === currentPlayer) playerElement.classList.add('self');
                    
                    playerElement.innerHTML = `
                        ${player} 
                        ${isReady ? '<span class="ready-status">已准备</span>' : ''}
                        ${isCurrent ? '<span class="current-marker">●</span>' : ''}
                    `;
                    
                    playerListElement.appendChild(playerElement);
                });
            }
        }

        function updatePlayerHand(cards) {
            const handContainer = document.getElementById('playerHand');
            handContainer.innerHTML = '';
            
            if (cards && cards.length > 0) {
                cards.sort((a, b) => a.value - b.value);
                
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.setAttribute('data-card', JSON.stringify(card));
                    cardElement.onclick = function() { selectCard(this); };
                    
                    // 设置卡牌左边距，实现扇形排列效果
                    cardElement.style.marginLeft = `${index * 30}px`;
                    
                    // 设置卡牌颜色
                    const isRed = card.suit === 'HEARTS' || card.suit === 'DIAMONDS';
                    const cardColor = isRed ? 'red' : 'black';
                    
                    // 设置卡牌花色符号
                    let suitSymbol = '♠';
                    switch (card.suit) {
                        case 'HEARTS': suitSymbol = '♥'; break;
                        case 'DIAMONDS': suitSymbol = '♦'; break;
                        case 'CLUBS': suitSymbol = '♣'; break;
                        case 'JOKER': suitSymbol = '🃏'; break;
                    }
                    
                    // 设置卡牌点数显示
                    let valueDisplay = card.value;
                    switch (card.value) {
                        case 1: valueDisplay = 'A'; break;
                        case 11: valueDisplay = 'J'; break;
                        case 12: valueDisplay = 'Q'; break;
                        case 13: valueDisplay = 'K'; break;
                    }
                    
                    cardElement.innerHTML = `
                        <span class="lt pv" style="color:${cardColor}">${valueDisplay}</span>
                        <span class="cm" style="color:${cardColor}">${suitSymbol}</span>
                        <span class="rb pv" style="color:${cardColor}">${valueDisplay}</span>
                    `;
                    
                    handContainer.appendChild(cardElement);
                });
            }
            
            document.getElementById('handCount').textContent = cards ? cards.length : 0;
        }

        function selectCard(element) {
            element.classList.toggle('selected');
            const card = JSON.parse(element.getAttribute('data-card'));
            
            // 检查卡片是否已经被选中
            const cardIndex = selectedCards.findIndex(c => 
                c.suit === card.suit && c.value === card.value
            );
            
            if (cardIndex === -1) {
                // 如果没有被选中，添加到选择列表
                selectedCards.push(card);
                playSound('cardSound');
            } else {
                // 如果已经被选中，从选择列表移除
                selectedCards.splice(cardIndex, 1);
            }
            
            // 更新声明值下拉框
            if (selectedCards.length > 0) {
                document.getElementById('declaredValue').value = selectedCards[0].value;
            }
        }

        function selectAllSameValue() {
            // 先获取当前选择的第一张牌的值
            if (selectedCards.length === 0) {
                alert('请先选择一张牌');
                return;
            }
            
            const selectedValue = selectedCards[0].value;
            
            // 查找所有具有相同值的卡片并选中它们
            const cards = document.querySelectorAll('.card');
            cards.forEach(cardElement => {
                const card = JSON.parse(cardElement.getAttribute('data-card'));
                if (card.value === selectedValue) {
                    if (!cardElement.classList.contains('selected')) {
                        cardElement.classList.add('selected');
                        selectedCards.push(card);
                    }
                }
            });
            
            playSound('cardSound');
        }

        function clearSelection() {
            const cards = document.querySelectorAll('.card.selected');
            cards.forEach(card => {
                card.classList.remove('selected');
            });
            selectedCards = [];
        }

        function updateCurrentPile(cards) {
            const pileContainer = document.getElementById('currentPile');
            pileContainer.innerHTML = '';
            
            if (cards && cards.length > 0) {
                // 创建牌堆元素
                cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card pile-card';
                    
                    // 设置卡牌位置，使其略微重叠
                    cardElement.style.top = `${index * 5}px`;
                    cardElement.style.left = `${index * 10}px`;
                    cardElement.style.zIndex = index + 1;
                    
                    // 设置卡牌颜色
                    const isRed = card.suit === 'HEARTS' || card.suit === 'DIAMONDS';
                    const cardColor = isRed ? 'red' : 'black';
                    
                    // 设置卡牌花色符号
                    let suitSymbol = '♠';
                    switch (card.suit) {
                        case 'HEARTS': suitSymbol = '♥'; break;
                        case 'DIAMONDS': suitSymbol = '♦'; break;
                        case 'CLUBS': suitSymbol = '♣'; break;
                        case 'JOKER': suitSymbol = '🃏'; break;
                    }
                    
                    // 设置卡牌点数显示
                    let valueDisplay = card.value;
                    switch (card.value) {
                        case 1: valueDisplay = 'A'; break;
                        case 11: valueDisplay = 'J'; break;
                        case 12: valueDisplay = 'Q'; break;
                        case 13: valueDisplay = 'K'; break;
                    }
                    
                    cardElement.innerHTML = `
                        <span class="lt pv" style="color:${cardColor}">${valueDisplay}</span>
                        <span class="cm" style="color:${cardColor}">${suitSymbol}</span>
                        <span class="rb pv" style="color:${cardColor}">${valueDisplay}</span>
                    `;
                    
                    pileContainer.appendChild(cardElement);
                });
            }
        }

        function addHistoryItem(message) {
            const historyList = document.getElementById('historyList');
            const historyItem = document.createElement('li');
            historyItem.textContent = message;
            historyList.appendChild(historyItem);
            
            // 自动滚动到底部
            historyList.scrollTop = historyList.scrollHeight;
        }

        function addChatMessage(chatMessage) {
            const chatList = document.getElementById('chatList');
            const chatItem = document.createElement('li');
            chatItem.innerHTML = `<strong>${chatMessage.sender}:</strong> ${chatMessage.content}`;
            
            // 如果是当前玩家的消息，添加样式
            if (chatMessage.sender === currentPlayer) {
                chatItem.classList.add('self-message');
            }
            
            chatList.appendChild(chatItem);
            
            // 自动滚动到底部
            chatList.scrollTop = chatList.scrollHeight;
        }

        function playCards() {
            if (selectedCards.length === 0) {
                alert('请选择要出的牌');
                return;
            }
            
            const declaredValue = document.getElementById('declaredValue').value;
            
            const message = {
                type: 'PLAY',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                cards: selectedCards,
                declaredCount: selectedCards.length,
                declaredValue: declaredValue
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // 添加到历史记录
            addHistoryItem(`${currentPlayer} 打出了 ${selectedCards.length} 张 ${declaredValue}`);
            
            // 清除选择
            clearSelection();
            
            // 播放音效
            playSound('cardSound');
        }

        function pass() {
            const message = {
                type: 'PASS',
                roomId: currentRoom.id,
                playerId: currentPlayer
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // 添加到历史记录
            addHistoryItem(`${currentPlayer} 选择了过牌`);
            
            // 播放音效
            playSound('cardSound');
        }

        function challenge() {
            if (!currentRoom.lastPlayer) {
                alert('没有可以质疑的玩家');
                return;
            }
            
            const message = {
                type: 'CHALLENGE',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                targetPlayerId: currentRoom.lastPlayer
            };
            
            stompClient.send("/app/game/action", {}, JSON.stringify(message));
            
            // 添加到历史记录
            addHistoryItem(`${currentPlayer} 质疑了 ${currentRoom.lastPlayer}`);
            
            // 播放音效
            playSound('challengeSound');
        }

        function sendChat() {
            const content = document.getElementById('chatInput').value.trim();
            if (!content) return;
            
            const message = {
                type: 'CHAT',
                roomId: currentRoom.id,
                playerId: currentPlayer,
                content: content
            };
            
            stompClient.send("/app/game/chat", {}, JSON.stringify(message));
            document.getElementById('chatInput').value = '';
        }

        function toggleEmojiPicker() {
            const emojiContainer = document.getElementById('emojiContainer');
            emojiContainer.style.display = emojiContainer.style.display === 'none' ? 'block' : 'none';
        }

        function addEmoji(emoji) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value += emoji;
            document.getElementById('emojiContainer').style.display = 'none';
            chatInput.focus();
        }

        function showGameResult(result) {
            const modal = document.getElementById('gameResultModal');
            const titleElement = document.getElementById('gameResultTitle');
            const messageElement = document.getElementById('gameResultMessage');
            const rankingElement = document.getElementById('playerRankingFinal');
            
            // 设置标题和消息
            titleElement.textContent = '游戏结束';
            messageElement.textContent = result.message || '游戏结束';
            
            // 显示玩家排名
            rankingElement.innerHTML = '';
            if (result.ranking && result.ranking.length > 0) {
                const rankingList = document.createElement('ol');
                result.ranking.forEach(player => {
                    const item = document.createElement('li');
                    item.textContent = `${player.name} - ${player.cards}张牌`;
                    rankingList.appendChild(item);
                });
                rankingElement.appendChild(rankingList);
            }
            
            // 显示弹窗
            modal.style.display = 'block';
            
            // 播放音效
            if (result.winner === currentPlayer) {
                playSound('winSound');
            } else {
                playSound('loseSound');
            }
        }

        function restartGame() {
            // 隐藏结果弹窗
            document.getElementById('gameResultModal').style.display = 'none';
            
            // 重新开始游戏
            fetch(`/api/game/room/${currentRoom.id}/restart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    playerId: currentPlayer
                })
            });
            
            // 重置准备状态
            isReady = false;
            document.getElementById('readyButton').classList.remove('ready-active');
            document.getElementById('readyButton').textContent = '准备';
            
            // 清除历史记录
            document.getElementById('historyList').innerHTML = '';
            
            // 清除选择
            clearSelection();
        }

        function playSound(soundId) {
            if (soundEnabled) {
                try {
                    const sound = document.getElementById(soundId);
                    sound.currentTime = 0;
                    sound.play();
                } catch (e) {
                    console.error('播放音效失败:', e);
                }
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundButton = document.getElementById('soundToggle');
            soundButton.textContent = soundEnabled ? '🔊' : '🔇';
        }

        // 处理游戏通知
        function handleNotification(notification) {
            var chatArea = $("#chatArea");
            var message = notification.content;
            
            // 不同类型的通知显示不同的样式
            var messageClass = "";
            if (notification.type === "JOIN") {
                messageClass = "join-notification";
            } else if (notification.type === "LEAVE") {
                messageClass = "leave-notification";
            } else if (notification.type === "PLAY") {
                messageClass = "play-notification";
            } else if (notification.type === "PASS") {
                messageClass = "pass-notification";
            } else if (notification.type === "CHALLENGE") {
                messageClass = "challenge-notification";
            } else if (notification.type === "GAME_START") {
                messageClass = "start-notification";
            } else if (notification.type === "GAME_END") {
                messageClass = "end-notification";
                // 游戏结束时显示排名弹窗
                showGameEndDialog(notification.content);
            } else if (notification.type === "ERROR") {
                messageClass = "error-notification";
            }
            
            chatArea.append("<p class='" + messageClass + "'>" + message + "</p>");
            chatArea.scrollTop(chatArea[0].scrollHeight);
        }
        
        // 显示游戏结束弹窗
        function showGameEndDialog(rankingText) {
            // 创建弹窗
            var dialog = $("<div class='game-end-dialog'></div>");
            var content = $("<div class='game-end-content'></div>");
            
            // 设置标题
            content.append("<h2>游戏结束</h2>");
            
            // 添加排名信息
            var rankingLines = rankingText.split("\n");
            var rankingHtml = "<div class='ranking'>";
            
            // 跳过第一行"游戏结束！排名："，从第二行开始
            for (var i = 1; i < rankingLines.length; i++) {
                rankingHtml += "<p>" + rankingLines[i] + "</p>";
            }
            rankingHtml += "</div>";
            content.append(rankingHtml);
            
            // 添加关闭按钮
            var closeButton = $("<button class='close-btn'>关闭</button>");
            closeButton.click(function() {
                dialog.remove();
            });
            content.append(closeButton);
            
            // 添加到弹窗
            dialog.append(content);
            
            // 添加到页面
            $("body").append(dialog);
        }
    </script>
</body>
</html>